#!/bin/bash
# Set KUBERNETES_MASTER to the URL of your cluster example http://kubemaster:8080
export KUBERNETES_MASTER

echo "RUNNING $JOB"

. /app/processor/reap && unset EXIT_CODE


K8S_JOB_LOWER=$(echo $JOB | tr '[:upper:]' '[:lower:]')

sed -e "0,/$JOB/{s/$JOB/$K8S_JOB_LOWER/}" /app/compose/$JOB.yaml > /app/compose/$JOB.lowercase.yaml
compose2kube -compose-file /app/compose/$JOB.lowercase.yaml -output-dir k8s_pod > /dev/null
rm /app/compose/$JOB.lowercase.yaml

if kubectl create -f k8s_pod/${JOB,,}-pod.yaml > /dev/null ; then
  rm k8s_pod/${JOB,,}-pod.yaml
else
  OUTPUT="Could not create pod. Exiting"
  EXIT_CODE=100
  return
fi

#Ensure the pod is actually registered. Avoids a possible race condition
until kubectl get pod $K8S_JOB_LOWER &> /dev/null
do
  sleep 0.1
done

#Label the pod
until kubectl label pods $K8S_JOB_LOWER jobrunner=$JOB &> /dev/null
do
  sleep 0.1
done



if [ "$FOLLOW" != true ] ; then
  OUTPUT="Running"
  EXIT_CODE=0
else
  while [ "$STATUS" != "Running" ]
  do
    . /app/processor/reap
  done

  kubectl logs -f $K8S_JOB_LOWER &

  while [ -z $EXIT_CODE ]
  do
    . /app/processor/reap
  done
fi

